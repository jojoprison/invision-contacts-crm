# Тестирование мультитенантного приложения Django-Ninja

## Архитектура мультитенантности

В проекте используется подход мультитенантности на основе **схем PostgreSQL**:

- Каждый тенант (арендатор) имеет свою схему в базе данных PostgreSQL
- Схемы изолированы друг от друга и имеют префикс `contact_`
- Middleware автоматически определяет схему на основе заголовка `X-SCHEMA` в запросе

## Настройка тестового окружения

Для запуска тестов используется pytest с дополнительными фикстурами для мультитенантной архитектуры:

### Основные фикстуры

- `setup_tenants`: Создает тестовые схемы, применяет миграции и очищает данные после тестов
- `tenant1_client`, `tenant2_client`: Django клиенты с настроенными заголовками X-SCHEMA
- `no_schema_client`: Клиент без заголовка схемы (для тестирования ошибок)
- `invalid_schema_client`: Клиент с невалидным заголовком схемы
- `create_contact`: Вспомогательная функция для создания контактов через API

### Процесс инициализации

1. Удаляются существующие тенанты из таблицы `tenants`
2. Удаляются схемы PostgreSQL (если они существуют) с использованием `DROP SCHEMA CASCADE`
3. Создаются новые схемы с помощью SQL-команды `CREATE SCHEMA`
4. Создаются записи тенантов в таблице `tenants`
5. Применяются миграции к каждой схеме отдельно
6. После завершения тестов все схемы и тенанты очищаются

## Особенности тестирования

### Изоляция данных

Тесты проверяют изоляцию данных между тенантами:

- `test_email_uniqueness_per_tenant`: Проверяет, что контакты с одинаковыми email могут существовать в разных тенантах
- `test_contact_count_isolation`: Проверяет, что количество контактов в одном тенанте не влияет на другого

### Валидация данных

Тесты проверяют валидацию данных:

- `test_create_contact_with_invalid_email`: Проверяет, что API отклоняет невалидный формат email

### Middleware

Тесты проверяют работу middleware тенантов:

- `test_no_schema_header`: Проверяет ответ, когда отсутствует заголовок X-SCHEMA
- `test_invalid_schema`: Проверяет ответ для несуществующей схемы

## Запуск тестов

```bash
# Запуск всех тестов
docker-compose exec web pytest src/tests/

# Запуск конкретного теста
docker-compose exec web pytest src/tests/tenant_isolation_test.py::test_email_uniqueness_per_tenant

# Запуск с подробным выводом
docker-compose exec web pytest src/tests/ -v
```

## Особенности реализации

### Префиксы схем

Константа `TENANT_SCHEMA_PREFIX = 'contact_'` определена в настройках приложения и используется для:

- Автоматического добавления префикса в middleware
- Создания схем в тестах
- Поиска тенантов в базе данных

### Миграции для схем тенантов

Для применения миграций к схеме тенанта используется команда:

```python
call_command('migrate_tenant_schema', schema_name)
```

### Настройки базы данных для тестов

Тесты используют обычную базу данных приложения (не создают отдельную тестовую базу).
В этом случае важно, чтобы тесты корректно очищали за собой данные.

## Возможные проблемы

- **Конфликты имен**: При параллельном запуске тестов возможны конфликты имен схем
- **Отсутствие очистки**: Если тесты завершаются аварийно, схемы могут не очиститься
- **Проблемы с правами доступа**: Пользователь базы данных должен иметь права на создание/удаление схем

## Рекомендации

- Используйте уникальные имена тенантов в разных тестовых наборах
- Добавьте периодическую очистку тестовых схем в CI/CD процесс
- Проверяйте наличие прав на создание схем у пользователя базы данных
